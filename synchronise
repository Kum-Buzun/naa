#!/bin/bash
#Copyright 2008-2009 Christopher Smart, under GPLv3 (a copy included in COPYING)

#Hi there. This script mounts an external device and rsyncs the ubuntu repository and clamav virus definitions.

# Some bash things:
# exists: -e
# is a file: -f
# is a directory: -d
# returned value is not null: -n
# is zero: -z
# something is equal to something else: =
# something is NOT equal to something else: != 
# or -o
# and -a

if [ -z "`ps ax |grep [u]pdate-system`" ]
then
	echo "Do not run this script directly, it is called by 'update-system'"
	echo "Exiting"
	exit 1
fi

#Variables should exist in the shell as they were exported by the 'update-system' script


clear
echo "-----------------------"
echo "Synchronising updates.."
rsync -a $MOUNTPOINT/data /

echo "Synchronisation - SUCCESS" >> $COMPLETEFILE

#Check if this is a new install
if [ "$STATUS" = "new" ]
then
	echo "Looks like you want to set up a new server, let's do it.."
	sleep 2

	#set up sources.lst
	if [ -z "`grep "/data/debs/" /etc/apt/sources.list`" ]
	then
		echo "deb file:///data/debs/ubuntu $DISTRO main restricted universe multiverse" > /etc/apt/sources.list
		echo "deb file:///data/debs/ubuntu $DISTRO-updates main restricted universe multiverse" >> /etc/apt/sources.list
		echo "deb file:///data/debs/ubuntu $DISTRO-security main restricted universe multiverse" >> /etc/apt/sources.list
	fi
	apt-get -qq update

	#Install apache
	echo "Installing web server and configuring Linux repository.."
	apt-get -qq install apache2

	#Set up deb archive links for clients
	cd /var/www/
	for x in `ls $MOUNTPOINT/data/debs`
	do
		ln -sf /data/debs/$x
	done

	#Add update drive to fstab
	if [ -z "`grep $DEVICE /etc/fstab`" ]
	then
		echo "$DEVICE $MOUNTPOINT auto noauto,noatime 0 0" >> /etc/fstab
	fi
	update-rc.d -f apparmor remove && /etc/init.d/apparmor stop
	echo "Installing services.."
	apt-get -qq install bind9 vim postfix htop logwatch dovecot-imap dovecot-common postgresql-8.3 nfs-kernel-server bash-completion

	#Postfix changes
	echo "`dnsdomainname`" > /etc/mailname
	sed -i s/#myorigin/myorigin/g /etc/postfix/main.cf
	sed -i s/mydestination\ =/mydestination\ =\ `dnsdomainname`,/g /etc/postfix/main.cf
	sed -i s/mynetworks\ =/mynetworks\ =\ $NETWORK\\/24,/g /etc/postfix/main.cf
	echo "Installation complete, configuring system.."

#	sed -i s/hello/hi/g test1
	#set syntax and jump in vimrc (use sed?)
	#set bash colours
	#set up ssh keys
	#create dpuser and add groups
	#configure nfs
	#set up /etc/hosts localhost to point to fqdn 
	#configure dns
	#configure sudo to run update-system without password


	echo "Setting up first time server - SUCCESS" >> $COMPLETEFILE
fi

#Update antivirus definitions
if [ -n "`dpkg -l |grep apache2`" -a -d "/var/www" ]
	then
		echo "------------------------------------"
		echo "Updating online virus definitions.."
		rsync -a /data/clamav/db/*cvd /var/www/
		echo "Copy ClamAV definitions to Apache - SUCCESS" >> $COMPLETEFILE
	else
		echo "------------------------------------"
		echo "Skipping antivirus update."
		echo "Copy ClamAV definitions to Apache - SKIPPED" >> $COMPLETEFILE
fi

#Quietly update apt database
echo "-----------------------------------------"
echo "Updating package local package database.."
apt-get -qq update
echo "Update apt database - SUCCESS" >> $COMPLETEFILE

#Print datestamp of virus defs
echo "-----------------------------------------"
echo "Checking ClamAV definitions.."
#Testing if the date on the ClamAV definitions are less than three days old. If so, good. If not, print check.
if [ `stat -c %Y /data/clamav/db/daily.cvd` -lt `date +%s --date "2 days ago"` ]
	then
		echo "Today is `date +%Y-%m-%d`."
		echo "Latest daily.cvd is dated `stat -c %Y /data/clamav/db/daily.cvd |awk {'print $1'}`."
		echo "Latest main.cvd is dated `stat -c %Y /data/clamav/db/main.cvd |awk {'print $1'}`."
		echo "Please compare the dates."
		echo ""
		echo "** HIT ENTER TO CONTINUE **"
		read
		echo "ClamAV definitions update - CHECK DATES" >> $COMPLETEFILE
	else
		echo "ClamAV definitions update - SUCCESS" >> $COMPLETEFILE
fi

#If this is marlin, backup the Amanda config files
if [ `hostname -f` = "marlin.dr.lan" ]
	then
		echo "--------------------------------"
		echo "Backing up Amanda config files.."
		mkdir -p $MOUNTPOINT/backup/marlin/etc/ 2>/dev/null
		rsync -a /etc/amanda* $MOUNTPOINT/backup/marlin/etc/
		rsync -a /usr/local/bin $MOUNTPOINT/backup/marlin/usr/local/
		echo "--------------------------------"
		echo "Amanda config backup - SUCCESS" >> $COMPLETEFILE
	else
		echo "-----------------------------"
fi

#Clean up error file - keeping these as logs now
#rm $ERRORFILE 2>/dev/null

#Summary of update
echo ""
echo "SUMMARY"
echo "-------"
echo "`cat $COMPLETEFILE`"
echo ""

#Clean up - keeping these as logs now
#rm $COMPLETEFILE
