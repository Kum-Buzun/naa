#! /bin/bash
#
# Script to be run via cron to perform a nightly backup of the DPR repository.
# Uses rsync for the backup and sends email to the admin on completion.
#
MAIL_TO="michael.carden@naa.gov.au matthew.oliver@naa.gov.au christopher.smart@naa.gov.au alan.langley@naa.gov.au"
RETRY_ATTEMPTS=5
tmp="/tmp/dprbackupresults"
echo "This message is generated by the DPR source repository backup script." > $tmp
echo "**********************************************************************" >> $tmp
echo "" >> $tmp
cd /backups/dpr

i=0
finish=0
while [ $finish -eq 0 ]
do
	rsync -av rsync://dpr.git.sourceforge.net/gitroot/dpr/dpr/ . >> $tmp
	if [ $? -ne 0 ]
	then
		#FAILED
		let "i+=1"
		if [ $i -gt $RETRY_ATTEMPTS ]
		then
			finish=1
		fi
	else
		finish=1
	fi
done

if [ $i -gt $RETRY_ATTEMPTS ]
then
	echo "Failed to rsync all $RETRY_ATTEMPTS attempts failed!" > $tmp
fi

mailx -s "DPR source backup results $(date)" $MAIL_TO < $tmp
rm $tmp
